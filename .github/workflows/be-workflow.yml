name: KTB Team20 Backend CI/CD (Maven Based)

on:
  push: # main Î∏åÎûúÏπòÏóê Ìë∏ÏãúÎê† ÎïåÎßàÎã§ ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ
    branches:
      - main
    paths: # Îã§Ïùå Í≤ΩÎ°úÏùò ÌååÏùºÏù¥ Î≥ÄÍ≤ΩÎê† ÎïåÎßå Ïã§Ìñâ
      - 'apps/backend/**' 
      - '.github/workflows/be-workflow.yml'

jobs:
  # 1. Maven ÌÖåÏä§Ìä∏ ÏàòÌñâ (ÌòÑÏû¨ DB Container Í¥ÄÎ†® Ïù¥ÏäàÎ°ú Ïù∏Ìï¥ ÏÉùÎûµ - Ï∂îÌõÑ ÏàòÏ†ïÌïÑÏöî)
  test:
    runs-on: ubuntu-latest
    env:
      JWT_SECRET: "this-is-a-very-long-and-secure-secret-key-for-ci-testing-42"
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java and Cache Maven Dependencies
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          cache-dependency-path: apps/backend/pom.xml 
      - name: Run Maven Tests
        run: cd apps/backend && ./mvnw clean package -DskipTests
  # 2. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
  build-and-push-image:
    needs: test
    runs-on: ubuntu-latest
    steps:
      # 2-1. Repository Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout repository
        uses: actions/checkout@v4
      # 2-2. AWS ÏûêÍ≤©Ï¶ùÎ™Ö ÏÑ§Ï†ï
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      # 2-3. S3Ïóê docker-compose-ci.yaml ÌååÏùº ÏóÖÎ°úÎìú
      - name: Upload docker-compose-ci.yaml to S3
        run: |
          aws s3 cp ./apps/backend/docker-compose-ci.yaml s3://${{ secrets.DEPLOY_BUCKET }}/backend/docker-compose.yaml
          aws s3 cp ./apps/backend/promtail-config.yaml s3://${{ secrets.DEPLOY_BUCKET }}/backend/promtail-config.yaml
      # 2-4. Docker Hub Î°úÍ∑∏Ïù∏
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      # 2-5. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          file: ./apps/backend/Dockerfile-ci
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/ktb-team20-be:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/ktb-team20-be:${{ github.sha }}
  # 3. Î∞∞Ìè¨
  deploy:
    needs: build-and-push-image
    runs-on: ubuntu-latest
    env: # Î∞∞Ìè¨Ïóê ÌïÑÏöîÌïú ÌôòÍ≤Ω Î≥ÄÏàò Î°úÎìú
      TARGET_GROUP_ARN: ${{ secrets.BE_TARGET_GROUP_ARN }}
      APP_USER: ubuntu
      IMAGE_TAG: ${{ github.sha }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEPLOY_BUCKET: ${{ secrets.DEPLOY_BUCKET }} 

    steps:
      # 3-1. Repository Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout repository
        uses: actions/checkout@v4
      # 3-2. AWS ÏûêÍ≤©Ï¶ùÎ™Ö ÏÑ§Ï†ï
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      # 3-3. Í∞Å Ïù∏Ïä§ÌÑ¥Ïä§ SSH Ï†ëÏÜçÏùÑ ÏúÑÌïú .pem key ÏÉùÏÑ±
      - name: Create PEM key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./key.pem
          chmod 600 ./key.pem
      # 3-4. S3ÏóêÏÑú ÌïÑÏöîÌïú ÌååÏùº Îã§Ïö¥Î°úÎìú
      - name: Download .env from S3
        run: |
          aws s3 cp s3://${{ env.DEPLOY_BUCKET }}/backend/.env ./.env
          aws s3 cp s3://${{ env.DEPLOY_BUCKET }}/backend/docker-compose.yaml ./docker-compose.yaml
          aws s3 cp s3://${{ env.DEPLOY_BUCKET }}/backend/promtail-config.yaml ./promtail-config.yaml
      # 3-5. ÎåÄÏÉÅ Í∑∏Î£πÏóêÏÑú Î∞∞Ìè¨ ÎåÄÏÉÅ Ïù∏Ïä§ÌÑ¥Ïä§ (IP) ÌôïÏù∏
      - name: Get EC2 IPs from Target Group
        id: get-ips
        run: |
          # 1. Target GroupÏóêÏÑú Instance IDÎì§ Î®ºÏ†Ä Í∞ÄÏ†∏Ïò§Í∏∞ (i-0xxxx ÌòïÌÉú)
          # Í≤∞Í≥º ÏòàÏãú: i-07b76d... i-06e6c...
          INSTANCE_IDS=$(aws elbv2 describe-target-health \
            --target-group-arn "${{ secrets.BE_TARGET_GROUP_ARN }}" \
            --query 'TargetHealthDescriptions[*].Target.Id' \
            --output text)
          if [ -z "$INSTANCE_IDS" ]; then
            echo "‚ùå Error: ÌÉÄÍ≤ü Í∑∏Î£πÏóê Ïó∞Í≤∞Îêú Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§."
            exit 1
          fi
          echo "üîç Í∞êÏßÄÎêú Instance IDs: $INSTANCE_IDS"
          # 2. [ÌïµÏã¨] Instance IDÎ•º Í∞ÄÏßÄÍ≥† -> 'Public IP' Ï°∞ÌöåÌïòÍ∏∞
          # aws ec2 describe-instances Î™ÖÎ†πÏñ¥Î•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.
          PUBLIC_IPS=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_IDS \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text)
          # 3. Í≤∞Í≥ºÍ∞í Ï†ïÏ†ú (ÌÉ≠/Ï§ÑÎ∞îÍøà -> Í≥µÎ∞±)
          CLEAN_IPS=$(echo "$PUBLIC_IPS" | tr '\t' ' ' | tr '\n' ' ')
          if [ -z "$CLEAN_IPS" ]; then
             echo "‚ùå Error: Ïù∏Ïä§ÌÑ¥Ïä§ IDÎäî Ï∞æÏïòÏúºÎÇò Public IPÎ•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. (Private SubnetÏóê ÏûàÎÇòÏöî?)"
             exit 1
          fi
          echo "‚úÖ ÏµúÏ¢Ö Ï∂îÏ∂úÎêú Public IPs: $CLEAN_IPS"
          echo "instance_ips=$CLEAN_IPS" >> $GITHUB_OUTPUT
      # 3-6. Î∞∞Ìè¨
      - name: Deploy to all instances
        run: |
          IFS=' ' read -r -a IPS <<< "${{ steps.get-ips.outputs.instance_ips }}"
          for IP in "${IPS[@]}"; do
            echo "--------------------------------------------------"
            echo "üöÄ [ÏàúÏ∞® Î∞∞Ìè¨ ÏãúÏûë] ÎåÄÏÉÅ IP: $IP"
            # 1. ÌååÏùº Ï†ÑÏÜ° (SCP)
            scp -i ./key.pem -o StrictHostKeyChecking=no ./docker-compose.yaml $APP_USER@$IP:/home/$APP_USER/docker-compose.yaml
            scp -i ./key.pem -o StrictHostKeyChecking=no ./promtail-config.yaml $APP_USER@$IP:/home/$APP_USER/./promtail-config.yaml
            scp -i ./key.pem -o StrictHostKeyChecking=no ./.env $APP_USER@$IP:/home/$APP_USER/.env  
            # 2. ÏõêÍ≤© Ï†ëÏÜç Î∞è Ïã§Ìñâ (SSH)
            ssh -i ./key.pem -o StrictHostKeyChecking=no $APP_USER@$IP << EOF
                set -e
                echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
                # Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ Î≥ÄÍ≤Ω
                sed -i 's|{{IMAGE_TAG}}|$IMAGE_TAG|g' /home/$APP_USER/docker-compose.yaml
                # Î∞∞Ìè¨ Î™ÖÎ†π
                docker compose -f /home/$APP_USER/docker-compose.yaml pull
                docker compose -f /home/$APP_USER/docker-compose.yaml down || true
                docker compose -f /home/$APP_USER/docker-compose.yaml up -d --remove-orphans --wait
          EOF
            echo "‚úÖ $IP Î∞∞Ìè¨ ÏôÑÎ£å"
            sleep 3
          done
          rm -f ./key.pem
          echo "üéâ Î™®Îì† ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏôÑÎ£å!"